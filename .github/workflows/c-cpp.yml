name: C/C++ CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc g++ lcov
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-10 100
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-10 100
        sudo update-alternatives --install /usr/bin/gcov gcov /usr/bin/gcov-10 100

    - name: Configure CMake
      run: cmake -B build \
                  -DCMAKE_C_COMPILER=gcc-10 \
                  -DCMAKE_CXX_COMPILER=g++-10 \
                  -DCMAKE_BUILD_TYPE=Debug \
                  -DENABLE_COVERAGE=ON

    - name: Build
      run: cmake --build build

    - name: Run tests
      run: ./build/plazza_tests

    - name: Generate coverage
      run: |
        lcov --gcov-tool gcov-10 \
             --capture \
             --directory build \
             --ignore-errors mismatch \
             --output-file coverage.info

        # Remove test files and CMake internals
        lcov --remove coverage.info \
             '*/test/*' \
             --output-file coverage_filtered.info

        # Show coverage summary
        lcov --summary coverage_filtered.info

        # Check threshold
        COVERAGE=$(lcov --summary coverage_filtered.info | grep lines | awk '{print $2}' | sed 's/%//')
        echo "Coverage: $COVERAGE%"
        if (( $(echo "$COVERAGE < 80" | bc -l) )); then
          echo "âŒ Coverage $COVERAGE% is below 80% threshold"
          exit 1
        fi
