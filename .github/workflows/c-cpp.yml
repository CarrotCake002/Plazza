name: C/C++ CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # Install dependencies and force GCC 13
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-13 g++-13 lcov cmake libgtest-dev make tree
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 100
        sudo update-alternatives --install /usr/bin/gcov gcov /usr/bin/gcov-13 100

        echo "=== TOOL VERSIONS ==="
        gcc --version
        g++ --version
        gcov --version
        lcov --version
        cmake --version

    # Build Google Test
    - name: Build GTest
      run: |
        mkdir -p build/gtest
        cd build/gtest
        cmake /usr/src/gtest
        cmake --build .
        echo "=== GTEST BUILD CONTENT ==="
        tree .

    # Configure your project
    - name: Configure CMake
      run: |
        cmake -B build \
          -DENABLE_COVERAGE=ON \
          -DCMAKE_BUILD_TYPE=Debug \
          -DGTEST_ROOT=build/gtest

        echo "=== CMAKE CACHE ==="
        grep -i coverage build/CMakeCache.txt || true
        grep -i gtest build/CMakeCache.txt || true

    # Build project
    - name: Build
      run: |
        cmake --build build --verbose

        echo "=== BUILD TREE ==="
        tree build | head -n 200

    # Inspect test binary BEFORE running it
    - name: Inspect test binary
      run: |
        echo "=== plazza_tests location ==="
        find build -name plazza_tests -type f

        echo "=== LINKED LIBS ==="
        ldd build/plazza_tests || true

        echo "=== CHECK COVERAGE FLAGS ==="
        strings build/plazza_tests | grep gcov || true

    # Run tests
    - name: Run tests
      run: |
        cd build
        echo "=== RUNNING TESTS ==="
        ./plazza_tests || true

    # Locate coverage files
    - name: Locate coverage files
      run: |
        echo "=== FIND .gcno FILES ==="
        find . -name "*.gcno" || true

        echo "=== FIND .gcda FILES ==="
        find . -name "*.gcda" || true

    # Generate coverage report (with debug)
    - name: Generate coverage
      run: |
        cd build

        echo "=== LCOV DIRECTORY SCAN ==="
        find . -maxdepth 3 -type f | head -n 200

        echo "=== CAPTURING COVERAGE ==="
        lcov \
          --gcov-tool gcov-13 \
          --capture \
          --directory . \
          --ignore-errors mismatch,empty \
          --output-file coverage.info

        echo "=== RAW COVERAGE INFO ==="
        head -n 50 coverage.info || true

        lcov \
          --remove coverage.info '*/test/*' '*/CMakeFiles/*' \
          --ignore-errors unused \
          --output-file coverage_filtered.info

        echo "=== COVERAGE SUMMARY ==="
        lcov --summary coverage_filtered.info
